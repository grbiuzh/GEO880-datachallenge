---
title: "Forecasting future movement from speed trajectories in Roe Deer using a linear predictive model and time series analysis"
subtitle: "Data challenge :GEO880, Patterns and Trends in Environmental Data - Computational Movement Analysis"
author: "Tim Fässler and Gregory Biland"
date: "30/05/2022"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    math: katex
---

```{r, echo = FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

  # html_document:
  #   theme: spacelab
  #   highlight: monochrome
  #   toc: true
  #   toc_float: true
  #   number_sections: true
  #   text-align: justify
  
``` 


```{r, message=FALSE, warning=FALSE,, include=FALSE}
Sys.setenv(LANG = "en")
library(readr)  # to import tabular data (e.g. csv)
library(tidyr)
library(tibble)
library(dplyr)        # to manipulate (tabular) data
library(sf)           # to handle spatial vector data
library(lubridate)    # To handle dates and times
library(ggplot2)
library(caTools)
library(caret)
library(raster)
library(prophet)
library(MASS)
library(jtools)
library(leaflet)
library(simplevis)

library(tseries)
library(ggfortify)
library(changepoint)
library(strucchange)
library(feasts)
library(forecast)
library(CINNA)
library(xts)
library(class)
library(caret)
library(moveHMM)


knitr::opts_chunk$set(
  message = F,
  fig.width = 7,
  fig.height = 6,
  pandoc.stack.size = "4g",
  fig.align = 'center',
  opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
)

dataFolder   <- here::here()   
RFolder      <- here::here()         
figureFolder <- here::here("figs") 
```

```{r, include=FALSE}

deer <- read_delim(file.path(dataFolder, "all_deer_complete.csv")) %>% data.frame()

canton_zh <- st_read(file.path(dataFolder,"Gemeindegrenzen_-OGD/UP_KANTON_F.shp"))
ASTK_ZH <- read_delim(file.path(dataFolder, "ASTK_ZH.csv"))
# ASTK <- read_delim(file.path(dataFolder, "Arealstatistik.csv"))
```

<div class=text-justify>

# Abstract
Animal movement has always been a complex field of study as it consists of and compiles the difficulties of ecology, geography and data science. This project seeks to merge these three disciplines as it tries to predict the future movement of Roe Deer through space with the usage of an linear model with constraints set up by typical biological behaviours of the Roe Deer.

# Background and research goals

With the continuous compaction of the soil and progressive sealing, the habitat of native species in Switzerland is increasingly under pressure [Note]. To counteract this pressure, it has become essential to sustainably protect the habitats of animals and thus preserve the diverse biodiversity. For this to be possible, it is essential to know where the animals move and where possible areas could be. In this way, it is possible to prevent roads and settlements from fragmenting animal habitats or negatively affecting the animals through the noise and anthropogenic influences. This prediction of habitats based on predicted movement distances is the content of this paper, which is based on GPS data of 15 tracked red deer in Zurich. Using GPS data from 15 deer in the south of the canton of Zurich, we evaluate the individual movement paths of three animals and attempt to use a time model to predict the speed at which the animals will move 24 hours after the last measurement point and thus determine the maximum distance the animals will travel. In order to be able to control for how much ground cover affects this prediction, a linear model was created to examine the relationship between area statistics and velocity.

Our research questions are:

- RQ.1: How accurately can movement in the future be modeled based on velocity using a predictive time model?

- RQ.2: What are the critical parameters for modeling and predicting deer movement ranges using a linear predictive model (LM), and how much do range statistics influence this model?

The research questions are answered utilizing a time analysis and models, as well as algorithms, and correlations between the parameters of the movement data are explained to show a final picture.

# Methods and data  {.tabset}

## Data

```{r}
head(deer)
```

## Preprocessing
```{r}
#deer <- deer %>% group_by(reh) %>% mutate(Name = randomNames(reh, ethnicity = 4)) #Give deer names
canton_zh <- canton_zh %>% subset(KANTON == "Zürich")
canton_zh <- canton_zh %>% st_transform(2056)

# ASTK <- ASTK %>% st_as_sf(coords = c("E", "N"), crs = 2056, remove = FALSE)
# ASTK_ZH <- st_join(canton_zh, ASTK, join = st_contains_properly, left=TRUE)
# ASTK_ZH <- ASTK_ZH %>% st_drop_geometry()
# write.csv(ASTK_ZH, file = "ASTK_ZH.csv", row.names=FALSE)

# Sex to binary: male = 0, female = 1, rename "reh" to "TierID"
deer$sex[deer$sex == "m"] <- as.numeric(0)
deer$sex[deer$sex == "f"] <- as.numeric(1)

deer <- deer %>% rename(TierID = reh, DatetimeUTC = datetime_utc)
colnames(deer)[c(3,4)] <- c("x","y")

deer <- deer %>% mutate(
  x = x + 2000000,
  y = y + 1000000
)

# Making a bounding box of the relevant study area
deer <- deer %>% st_as_sf(coords = c("x", "y"), crs = 2056, remove = FALSE) 
bbox <- st_make_grid(st_bbox(deer), n = 1)
bbox_df <- bbox[[1]][[1]] %>% data.frame()
deer <- deer %>% st_drop_geometry()

# Making the bounding box a bit bigger, so that our predictions can go further outside, 1km on every side
bbox_df$X1[1] = bbox_df$X1[1] - 1000
bbox_df$X1[2] = bbox_df$X1[2] + 1000
bbox_df$X1[3] = bbox_df$X1[3] + 1000
bbox_df$X1[4] = bbox_df$X1[4] - 1000
bbox_df$X1[5] = bbox_df$X1[5] - 1000

bbox_df$X2[1] = bbox_df$X2[1] - 1000
bbox_df$X2[2] = bbox_df$X2[2] - 1000
bbox_df$X2[3] = bbox_df$X2[3] + 1000
bbox_df$X2[4] = bbox_df$X2[4] + 1000
bbox_df$X2[5] = bbox_df$X2[5] - 1000
bbox_sf <- bbox_df %>% st_as_sf(coords = c('X1', 'X2'), crs = 2056)

bbox_sf <- bbox_sf %>% 
  summarise(geometry = st_combine(geometry)) %>%
  st_cast("POLYGON")

bbox_sf <- bbox_sf %>% st_transform(2056)

```

```{r}
#Rename deer as numeric and remove long lat
deer <- deer %>% mutate(sex = as.numeric(sex))

```

```{r}
#Plot data for overview
deer_sf_LL <- deer %>% st_as_sf(coords = c("longitude", "latitude"), crs = 2056, remove = FALSE)
deer_sf <- deer %>% st_as_sf(coords = c("x", "y"), crs = 2056, remove = FALSE)
ggplot()+
  geom_sf(data=bbox_sf, alpha=.1)+
  geom_path(data = deer,aes(x,y,  col = TierID))+
  geom_point(data = deer,aes(x,y, col = TierID))+
  ggtitle("Movement patterns for 15 different roe deer with the bounding box for \nthe observation field around")+
  xlab("X")+
  ylab("Y")+
  theme_minimal() +
  coord_sf(datum = 2056)

# leaf_sf_col(deer_sf_LL, 
#                col_var = TierID)
```

## Geometry calculations 

```{r}
deer <- deer %>% group_by(TierID) %>% mutate(
  timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC, units = 'secs')), #timelag is in seconds
  steplength = sqrt((y - lead(y,1))^2+ (x - lead(x,1))^2))

deer <- deer %>% mutate(speed = (steplength / timelag)) #speed is in meter per minute
deer <- deer %>% drop_na() %>% data.frame() %>% subset(select= -c(longitude, latitude) )
```

## Outlier Handling

```{r}

deer_quantiles_speed <- deer %>% group_by(TierID) %>% summarize(qua1 = quantile(speed, 0.01, na.rm = TRUE), qua2 = quantile(speed, 0.99, na.rm = TRUE))

deer <- deer %>% split(deer$TierID)

deer$RE01 <- deer$RE01[deer$RE01$speed >= deer_quantiles_speed$qua1[1] & 
                       deer$RE01$speed <= deer_quantiles_speed$qua2[1],]
deer$RE02 <- deer$RE02[deer$RE02$speed >= deer_quantiles_speed$qua1[2] & 
                       deer$RE02$speed <= deer_quantiles_speed$qua2[2],]
deer$RE03 <- deer$RE03[deer$RE03$speed >= deer_quantiles_speed$qua1[3] & 
                       deer$RE03$speed <= deer_quantiles_speed$qua2[3],]
deer$RE04 <- deer$RE04[deer$RE04$speed >= deer_quantiles_speed$qua1[4] & 
                       deer$RE04$speed <= deer_quantiles_speed$qua2[4],]
deer$RE05 <- deer$RE05[deer$RE05$speed >= deer_quantiles_speed$qua1[5] & 
                       deer$RE05$speed <= deer_quantiles_speed$qua2[5],]
deer$RE06 <- deer$RE06[deer$RE06$speed >= deer_quantiles_speed$qua1[6] & 
                       deer$RE06$speed <= deer_quantiles_speed$qua2[6],]
deer$RE07 <- deer$RE07[deer$RE07$speed >= deer_quantiles_speed$qua1[7] & 
                       deer$RE07$speed <= deer_quantiles_speed$qua2[7],]
deer$RE08 <- deer$RE08[deer$RE08$speed >= deer_quantiles_speed$qua1[8] & 
                       deer$RE08$speed <= deer_quantiles_speed$qua2[8],]
deer$RE09 <- deer$RE09[deer$RE09$speed >= deer_quantiles_speed$qua1[9] & 
                       deer$RE09$speed <= deer_quantiles_speed$qua2[9],]
deer$RE010 <- deer$RE010[deer$RE010$speed >= deer_quantiles_speed$qua1[10] & 
                       deer$RE010$speed <= deer_quantiles_speed$qua2[10],]
deer$RE011 <- deer$RE011[deer$RE011$speed >= deer_quantiles_speed$qua1[11] & 
                       deer$RE011$speed <= deer_quantiles_speed$qua2[11],]
deer$RE012 <- deer$RE012[deer$RE012$speed >= deer_quantiles_speed$qua1[12] & 
                       deer$RE012$speed <= deer_quantiles_speed$qua2[12],]
deer$RE013 <- deer$RE013[deer$RE013$speed >= deer_quantiles_speed$qua1[13] & 
                       deer$RE013$speed <= deer_quantiles_speed$qua2[13],]
deer$RE014 <- deer$RE014[deer$RE014$speed >= deer_quantiles_speed$qua1[14] & 
                       deer$RE014$speed <= deer_quantiles_speed$qua2[14],]
deer$RE015 <- deer$RE015[deer$RE015$speed >= deer_quantiles_speed$qua1[15] & 
                       deer$RE015$speed <= deer_quantiles_speed$qua2[15],]

deer_cleaned <- do.call(rbind, deer)

# Recalculating timelag, steplength and speed

deer_cleaned <- deer_cleaned %>% group_by(TierID) %>% mutate(
  timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC, units = 'secs')), #timelag is in minutes
  steplength = sqrt((y - lead(y,1))^2+ (x - lead(x,1))^2)) %>% mutate(speed = (steplength / timelag))

# Calculating additional attribute
colnames(deer_cleaned)[3] <- "ID"
deer_cleaned <- prepData(deer_cleaned, type = "UTM", ) %>% 
  data.frame() %>% 
  subset(select = -step) %>% 
  relocate(angle, .after = speed) %>%
  rename(TierID = ID) %>%
  relocate(TierID, .before = sex)

```


```{r}
# So wärs mit 0.01 und 0.99 percentil removed, chönd au no meh filtere
ggplot()+
  geom_sf(data=bbox_sf, alpha=.1)+
  geom_path(data = deer_cleaned,aes(x,y,  col = TierID))+
  geom_point(data = deer_cleaned,aes(x,y, col = TierID))+
  ggtitle("Movement patterns for 15 different roe deer with the bounding box for the observation field around")+
  xlab("X")+
  ylab("Y")+
  theme_minimal() +
  coord_sf(datum = 2056)
```

```{r}
ggplot()+
  geom_line(data = deer_cleaned, aes(x=DatetimeUTC, y = speed, col= TierID))+
  ggtitle("Monitoring timespan for 15 different roe deer")+
  ylab("Speed [m/s]")+
  xlab("Deer")

ggplot()+
  geom_line(data = deer_cleaned, aes(x=DatetimeUTC, y = steplength, col= TierID))+
  ggtitle("Monitoring timespan for 15 different roe deer")+
  ylab("Steplegth [m]")+
  xlab("Deer")

ggplot()+
  geom_line(data = deer_cleaned, aes(x=DatetimeUTC, y = timelag, col= TierID))+
  ggtitle("Monitoring timespan for 15 different roe deer")+
  ylab("Steplegth [m]")+
  xlab("Deer")
```

## Arealstatistik

```{r}

# Updating bounding box
bbox_df$X2[c(1,2,5)] <- min(deer_cleaned$y) - 1000

bbox_sf <- bbox_df %>% st_as_sf(coords = c('X1', 'X2'), crs = 2056)
bbox_sf <- bbox_sf %>% 
  summarise(geometry = st_combine(geometry)) %>%
  st_cast("POLYGON")
bbox_sf <- bbox_sf %>% st_transform(2056)



# Extracting the relevant cells of the Arealstatistik
ASTK_ZH <- ASTK_ZH %>% st_as_sf(coords = c("E", "N"), crs = 2056, remove = FALSE)
ASTK_bbox <- st_join(bbox_sf, ASTK_ZH, join = st_contains_properly, left=TRUE)
ASTK_bbox <- ASTK_bbox %>% st_drop_geometry()

# Chosing which classification of the Arealstatistik we want to use
ASTK_bbox <- ASTK_bbox %>% dplyr::select(RELI, E, N, AS18_72)

# Making an empty raster with the extent of the Arealstatistik
empty_raster <- raster(
  ncols = (range(ASTK_bbox$E)[2]-range(ASTK_bbox$E)[1])/100+1, 
  nrows =  (range(ASTK_bbox$N)[2]-range(ASTK_bbox$N)[1])/100+1, 
  xmn = min(ASTK_bbox$E)-50, 
  xmx = max(ASTK_bbox$E)+50, 
  ymn = min(ASTK_bbox$N)-50,
  ymx = max(ASTK_bbox$N)+50
  )

# Populating the raster
ASTK_raster <- rasterize(dplyr::select(ASTK_bbox, E, N), empty_raster, ASTK_bbox$AS18_72) 

# Adding arealstatistik values to deer data
deer_cleaned <- data.frame(deer_cleaned)
deer_cleaned <- deer_cleaned %>% mutate(astk = as.vector(extract(ASTK_raster, st_as_sf(deer_cleaned, coords = c("x", "y")) , 'simple')))

deer_cleaned$astk[is.na(deer_cleaned$astk)] <- 0
deer_cleaned <- deer_cleaned %>% na.omit()
```

```{r}
raster_vis <- as.data.frame(ASTK_raster, xy = TRUE)

ggplot()+
  # geom_sf(data = canton_zh, fill = alpha("white", .1))+
  geom_sf(data = bbox_sf)+
  geom_raster(data = raster_vis, aes(x = x, y = y, alpha = layer))+
  geom_path(data = deer_cleaned, aes(x = x, y = y, col = TierID), alpha = 0.3)+
  geom_point(data = deer_cleaned, aes(x = x, y = y, col = TierID), size = .1)+
  coord_sf(datum = 2056)+
  theme_minimal()+
  ggtitle("Tracking points for roe deer")
  
ggplot()+
  geom_raster(data = raster_vis, aes(x = x, y = y, alpha = layer))+
  coord_sf(datum = 2056)+
  geom_point(data = deer_cleaned, aes(x,y, color = as.factor(astk)))+
  geom_path(data = deer_cleaned, aes(x = x, y = y), alpha = 0.3)+
  theme_minimal()+
  ggtitle("Tracking points for roe deer with the Arealstatistik")
```

## Methods

For the further analysis of habitats and potential movement areas, not all 15 deer were used more than that a time analysis for 15 differing time periods does not allow conclusive results. Consequently, deer no. 1, 2 and 3 were selected and used for the methodology of the forecast. Thus, the stag has 1908 measurement points, stag 2 5894 and stag 3 5290. The datasets have been additionally cleaned, so that all lines, which showed a "NoValue" after the above analysis, have been removed. Thus, a total of 13092 measurement points were used, which corresponds to a good 17% of all measurement points and thus represents a large enough sample to make a conclusion and forecast for all measurement points of the 15 deer possible. 

```{r}
# Filte roe deer 1,2 and 3 and change coordinates to sf object
deer_01 <- deer_cleaned %>% filter(TierID == "RE01") %>% na.omit()
deer_02 <- deer_cleaned %>% filter(TierID == "RE02") %>% na.omit()
deer_03 <- deer_cleaned %>% filter(TierID == "RE03") %>% na.omit()

deer1_3 <- rbind(deer_01, deer_02, deer_03)

deer_01_sf <- deer_01 %>% st_as_sf(coords = c("x", "y"), crs = 2056, remove = FALSE)
deer_02_sf <- deer_01 %>% st_as_sf(coords = c("x", "y"), crs = 2056, remove = FALSE)
deer_03_sf <- deer_01 %>% st_as_sf(coords = c("x", "y"), crs = 2056, remove = FALSE)

```

## Change points in speed

In order to be able to compare whether in the time series, which is examined in the further analysis, the velocity changes strikingly and so-called "change points" occur, a change point analysis was carried out for the subset of roe deers. For this purpose the "BinSeg" method of analysis was used, which is not very accurate but allows a high computational speed compared to other approaches, which is essential for a data set of the size used in this study. 

The used test for the change points was the "Classification Permutation Test (CPT)" method. This non-parametric test for equality of multivariate distributions. trains a classifier to classify (multivariate) observations as coming from one of several distributions. If the classifier is able to classify the observations better than would be expected by chance (using permutation inference), then the null hypothesis that the distributions are equal is rejected.

```{r}
#Overview over changepoints in speed for the roe deer
CP_value01 = cpt.mean(deer_01$speed, method= "BinSeg") # Using method "binseg" cause it is quick but only approximate

CP_value02 = cpt.mean(deer_02$speed, method= "BinSeg") # Using method "binseg" cause it is quick but only approximate

CP_value03 = cpt.mean(deer_03$speed, method= "BinSeg") # Using method "binseg" cause it is quick but only approximate
```

## Speed forcasting

For the prediction of the velocities on the basis of a time model, the package "Prophet" was used, which creates a time model based on time data and a feature type, i.e. a variable, and on the basis of the seasonalities and fluctuations contained therein, creates a forecast of the values to be achieved. In this model, the speed for the next 24 hours was modeled, for each of the three deer separately. Further, a general trend was calculated by means of the model, which algorithmically analyzes the fluctuations of the days and weeks and creates a trend curve.  The "speed forcasting" function used for this purpose calculates the average speed of each movement segment of the individual animals and predicts the next 24 hours of the animals' speed by means of an additional data set with 24 periods. This results in an additional data set, with the upper and lower trend values of the already existing data and those in the future, which are supplemented with the uncertainty range of the respective predicted values. 

```{r}
### Forecasting speed 
speed_forcasting <- function(file){
  deer_mean_speed = file %>% 
  group_by(DatetimeUTC) %>% 
  summarise(speed = mean(speed, na.rm = TRUE)) %>% 
  ungroup() %>% 
  rename(ds = DatetimeUTC, y = speed)

m.s= prophet(df = deer_mean_speed)

future.s = make_future_dataframe(m = m.s, 
                               periods = 24, 
                               freq = "day")

future.speed = stats::predict(m.s, future.s)

print(plot(m.s,future.speed) +
  theme_bw()+
  theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14))+
  labs(x = NULL, y = expression(Roe~deer~speed~(m/s), title = "Timemodel speed prediction for the movement speed in roe deer")))

dyplot.prophet(x = m.s, fcst = future.speed,uncertainty = TRUE )

prophet_plot_components(m = m.s, fcst = future.speed)
}

```

Time serie analysis for the three roe deer, implemented in a visualization of the observed values, versus the predicted values from the model, with the dark blue line indicating the predicted values, while the light blue area indicates the uncertainty area of the time series speed prediction. The output which was generated also shows the hourly but also weekly trends in the changes of the velocities, which allows a conclusion on a possible behavioral pattern of the animals. 

```{r}
deer_01_s.f <- speed_forcasting(deer_01)
```

Time series speed prediction for roe deer 2:

```{r}
deer_02_s.f <- speed_forcasting(deer_02)
```
Time series speed prediction for roe deer 3:

```{r}
deer_03_s.f <- speed_forcasting(deer_03)
```

## Home range estimation

From the forecast data of the time model, the upper and lower trend values of the forecasted 24h were used to predict the homerange, i.e. the possible residence areas of the animals. For this purpose, two areas were calculated: a minimum and a maximum distance which is possible for the animal on the basis of the forecast. The functions "min max" calculated first by means of the lower and upper prognosis border, the distance in meters, which the animal can reach, if it holds the prognosticated averaged speed over the next 24h. From the distance resulting from it by means of the function "Homerange" a minimum and a maximum distance buffer were computed and assigned to the coordinates of the all last measurement. Additionally  

```{r}
min_max <- function(file){ 
  min_speed = tail(file[[1]][["data"]][["trend_lower"]], n = 1) 
  max_speed = tail(file[[1]][["data"]][["trend_upper"]], n = 1)
  trend = tail(file[[1]][["data"]][["trend"]], n = 1)
  min_distance = (min_speed * 86400)
  max_distance = (max_speed * 86400)
  trend = (trend * 86400)
  df <- data.frame (min_HR = min_speed,
                    max_HR = max_speed,
                    min_distance = min_distance,
                    max_distance = max_distance,
                    trend = trend)
}

deer01_HR <- min_max(deer_01_s.f)
deer02_HR <- min_max(deer_02_s.f)
deer03_HR <- min_max(deer_03_s.f)

#Home range distance definition
homerange <- function(file, f1){
  last_point_x = last(file$x)
  last_point_y = last(file$y)
  
  buffer_point <- data.frame(x = last_point_x, y = last_point_y)
  buffer_point <- buffer_point %>% st_as_sf(coords = c("x", "y"), crs = 2056, remove = FALSE)
  
  min_buffer = buffer_point %>% st_buffer(dist= f1$min_distance)
  max_buffer = buffer_point %>% st_buffer(dist= f1$max_distance)
  trend_buffer = buffer_point %>% st_buffer(dist= f1$trend)
  rbind(min_buffer, max_buffer, trend_buffer)
}

homerange_deer1 <- homerange(deer_01, deer01_HR)
homerange_deer2 <- homerange(deer_02, deer02_HR)
homerange_deer3 <- homerange(deer_03, deer03_HR)

```

In addition to the minimum and maximum velocity values calculated by the model, the trend value was also used to calculate a third distance value that best reflects the possible distance over time. These distance values are visualized in the following plot, where the minimum and maximum travel distance for the deer 1, 2 and 3 are shown and complemented by the trend values. Thus, the minimum distance is shown in green, the maximum distance value in red and the optimal trend value in blue.  

```{r}
HR123 <- rbind(deer01_HR,deer02_HR,deer03_HR)
HR123$deer_number <- seq.int(nrow(HR123)) 
```

```{r, fig.cap= "Fig. 1: Roaming distances for roe deer in the proximate future"}
ggplot()+
  geom_line(data = HR123, aes(y=min_distance,x = deer_number, col = "green"))+
  geom_line(data = HR123, aes(y=max_distance,x = deer_number, col = "yellow"))+
  geom_line(data = HR123, aes(y=trend,x = deer_number, col = "orange"))+
  ylab("Homerange distances [m]")+
  xlab("Deer")+
  labs(colour='Homerange distance type')+
  scale_color_manual(labels = c("Minimum distance","Trend distance", "Maximum distance"),
                     values = c("green", "blue", "red"))
```

## Linear predictive model

As a final methodological step for the analysis and prediction of deer velocities, linear models and a k-nearest-neighbor algorithm were used to determine the statistical relationship of velocity with the variables: "sex, distance between two measurement points, time difference, ground cover according to the Arealstatistik and the turning angle between to following trajectory segments. For the comparison of the velocity values among themselves and how they influence each other, the KNN algorithm was used and the velocity values were classified to determine if the velocity is autocorrelated or not, from the resulting data a further prediction of the velocity was derived to better assess the uncertainty of the previous linear models. To compare the different outputs of the KNN algorithm, a 10-fold cross-validation was performed, which compares the possible combinations of sample size and variables used and selects the best model. A seed was also set for this, as for the linear models, in order to obtain the same outputs of the models in further analyses.  

```{r LM}
# https://cran.r-project.org/web/packages/jtools/vignettes/effect_plot.html
#Linear approach
fit <- lm(speed ~ sex + timelag + x + y + steplength + astk + angle, data = deer_cleaned)
fit_poly.astk <- lm(speed ~ sex + timelag + x + y + steplength + poly(astk, 2) + angle, data = deer_cleaned)
fit_poly.sex <- lm(speed ~ poly(sex, 1) + timelag + x + y + steplength + astk + angle, data = deer_cleaned)

#predicts the future values
s.astk.model <- lm(speed~astk,data = deer_cleaned)
s.sex.model <- lm(speed~sex,data = deer_cleaned)

variable_astk <-data.frame(astk=c(deer_cleaned$astk))
p1_astk <- predict(s.astk.model, newdata = variable_astk)
p2_astk <- predict(s.astk.model, newdata = variable_astk,interval = 'confidence')

variable_sex <-data.frame(sex=c(deer_cleaned$sex))
p1_sex <- predict(s.sex.model, newdata = variable_sex)
p2_sex <- predict(s.sex.model, newdata = variable_sex,interval = 'confidence')

# KNN- algorithm approach with prediction of speed
# Define training control
set.seed(54)

train.control <- trainControl(method = "cv", number = 10)

# Train the model
model <- train(speed ~ sex + timelag + x + y + steplength + astk+ angle
               , data = deer_cleaned
               , trControl = train.control, method = "knn")

# Summarize the results
predict_model_speed <- predict(model)
predict_model_speed <- predict_model_speed %>% data.frame()
predict_model_speed$row_num <- seq.int(nrow(predict_model_speed)) 
deer_cleaned$row_num <- seq.int(nrow(deer_cleaned)) 
```


# Results

## Time series

When analyzing the results of the time series, several clear patterns emerge. For example, none of the three-time series is the same in several aspects, suggesting that the animals moved independently since velocity distribution varies significantly among the three animals. While deer 1 and 2 show a very constant velocity over time (Figure 2 and 3), with only two outliers where the velocity increased markedly, the velocity of deer 3 (Figure 4) is much more fluctuating and varies massively over time than that of the other animals. Only the time series of the second animal shows two jumps in the speed with the temporary increase of the speed, which is not the case with the first animal. The same pattern as in the time analysis shows up in the trend of the values, so the trend of the animal 2 is jumpy big and again small in summer and winter 2014, while the enormously increasing speed of the first animal shows up with an increasing trend for the two outliers in October of the same year.
Further, it can be noted that the fluctuations and changes daily and weekly do not follow the same pattern for all three animals. All are mainly active at different times and not on the same days of the week. The second animal increased in the evening fast on the move, while the other two deer are alternately active throughout the day and increased at midday and morning hours. The trend of the third animal also deviates strongly from the other animals, where this was in the summer in each case strongly more slowly, i.e., less on the way than the two other animals. 

```{r, fig.cap= "Fig. 2: Time series speed predction for roe deer #1"}
deer_01_s.f <- speed_forcasting(deer_01)

```
```{r, fig.cap= "Fig. 3: Time series speed predction for roe deer #2"}
deer_02_s.f <- speed_forcasting(deer_02)
```

```{r, fig.cap= "Fig. 4: Time series speed predction for roe deer #3"}
deer_02_s.f <- speed_forcasting(deer_02)
```


Comparing the time series of the three deer, which show strongly varying and different patterns, the results of the changepoint analyses are exceptionally homogeneous and deviate minimally from each other. All three-time series show no significant changes in velocity and, therefore, no changepoints, i.e., moments in the time series where the velocity has changed abruptly. Thus, the BIC (Bayesian Information Criterion) for all three changepoint models is between 20 and 30 and, accordingly, very small. These values indicate that the time series, i.e., the model, has analyzed the velocity very poorly; thus, the error range is extensive. This is even more significant as the time travel from the above section has shown an opposite picture, and the plot of the velocities show massive differences over time, which should have been reflected in the changepoint analysis, but is not the case, but can be explained by the low MBIC values because the model is fragile. Thus, it would have been expected that a changepoint would have occurred at least at those points where the CPT model shows a trend change in the time series and the trend values change abruptly in the short term. 

## Change points and travel distance prognosis

```{r}
CP_value01
cpts(CP_value01)

plot(CP_value01,xlab="Day", ylab = "Speed [m/s]" ,main =" Change points in the speed of roe deer 1")

CP_value02
cpts(CP_value02)

plot(CP_value02,xlab="Day", ylab = "Speed [m/s]" ,main =" Change points in the speed of roe deer 2")

CP_value03
cpts(CP_value03)

plot(CP_value03,xlab="Day", ylab = "Speed [m/s]" ,main =" Change points in the speed of roe deer 3")


```

These significant differences in the movement area speeds are also reflected in the predicted distance buffers that the three animals will cover within the predicted 24 hours. While animals 1 (red) and 2 (green) have a massively more considerable variance than the third animal (blue), their distances are also almost twice as large as those of the third animal. Thus, it is predicted (Figure 1) that animal one will travel between 1000 and 1400 meters in the next 24h, while animal two will travel between 500 and 1250 meters. The pattern is entirely different for the third deer, which has a minimal variance and only travels 750 meters with a dispersion of fewer than 25 meters. 

```{r}
ggplot()+
  geom_path(data = deer1_3, aes(x,y, col = TierID))+
  geom_point(data = deer1_3, aes(x,y, col = TierID))+
  geom_sf(data = homerange_deer1, col = "red", alpha = .1)+
  geom_sf(data = homerange_deer2, col = "darkgreen", alpha = .1)+
  geom_sf(data = homerange_deer3, col = "blue", alpha = .1)+
  ggtitle("Predicted homerange for Roe deer 1,2 and 3 in the next 24 hours \nwith the minimum and maximum distance")+
  xlab("X")+
  ylab("Y")+
  theme_minimal()+
  coord_sf(datum = 2056)
```

## Linear model evaluation

While in the first part of the paper, the focus was on predicting the distance, i.e., the movement field of three roe dees, the results in the following part are used to make a statement about how the speed depends on other movement parameters and how this affects the movement mentioned above distances and the time model. The model that used all variables to explain the velocity has an R-squared value of 0.29 and thus performs very poorly, as only 29% of the variance of all velocity values can be explained, leaving an enormous uncertainty range. What is worth noting, however, is that all variables have a significant effect on velocity, except for the x-coordinate. Further, however, the estimate values are minimal, which seems to make sense, as the speed changes only minimally when the distance or time increases slightly and does not make exponential jumps. The p-value smaller than 0.05 additionally indicates that the model explains the velocity significantly and thus performs less poorly than the R-value. A less successful picture is shown by the models where the explanatory variable is the "area statistics (astk) and sex" here, the p-values are smaller than 0.05 and the t-values as well, but the r-value is equal to 0, and thus the variables "astk" and "sex" alone do not explain the velocity at all and are not sufficient alone for the prediction or explanation. Difficult at the model, which uses the variable "sex," however, is that it concerns a binary value, so the estimated value can rise or sink only around one and has with a value of -0.0015753 no influence alone on it, how strongly the speed changes, i.e., the sex does not define the speed. The same is true for the variable "astk," where the velocity hardly changes when the soil type changes because the estimated value is only -7.826e-05, i.e., negligible. In addition, the gender, the time, and the coordinates decrease the speed, while the angle, the areal statistics, and the distance increase the speed. 


```{r}
#Summary
summary(fit)
summary(s.astk.model)
summary(s.sex.model)
```


## Statistics

Compared to the output of the models, the results of the visualizations of the statistics of the models look different, so all three models show a slight linear relationship between the variables. Although the Q-Q plots indicate that the values could be normally distributed, all three models show strong outliers in the higher theoretical quantiles, which questions the normal distribution. The scale location plots reflect the results of the above analysis and show an apparent heteroskedasticity problem. Many of the velocities are clumped and not evenly distributed, i.e., the animals do not move evenly but very unsporadically fast and slow again, which was also seen in the time analysis in the daily and weekly changes curves. Less surprising is that the outliers in all models are about the same size and have only a negligible influence on the overall result of the model. 

```{r}
autoplot(fit)
autoplot(fit_poly.astk)
autoplot(fit_poly.sex)
```

The following plots serve to further confirm the above statistical outputs of the results of the three models. Again, it can be seen that there is no significant correlation between areal statistics and gender in any of the three models, i.e., the changes in velocity are negligible when the ground or gender changes and would likely not change the movement zones from Figure 1. Even with a polynomial fit of the variable to the velocity, the picture does not improve, although the results of the LM evaluation actually indicated that the values should be normally distributed and thus a linear model would seem reasonable. 

```{r}
effect_plot(fit, pred = astk, interval = TRUE, plot.points = TRUE)
effect_plot(fit, pred = sex, interval = TRUE, plot.points = TRUE)
effect_plot(s.astk.model, pred = astk, interval = TRUE, plot.points = TRUE)
effect_plot(s.sex.model, pred = sex, interval = TRUE, plot.points = TRUE)

effect_plot(fit_poly.astk, pred = astk, interval = TRUE, plot.points = TRUE)
effect_plot(fit_poly.sex, pred = sex, interval = TRUE, plot.points = TRUE)

effect_plot(fit, pred = astk, interval = TRUE, plot.points = TRUE,
            jitter = .2)
```

## Variable relationship

```{r}
plot(p1_astk)
plot(p2_astk)

plot(p1_sex)
plot(p2_sex)
```

## Speed prediction usign KNN

Finally, compared to the linear model, the results of the KNN model are very different from the linear model. Here the velocities were classified as mentioned to make a prediction of the velocity. In contrast to the changepoint analyses, where no differences in the values of the velocities were found, the KNN model shows that in all values 5 to 9 clusters can be formed, where the velocities of the animals could be similar enough to belong to the same animal. This is particularly interesting because the model contains 15 animals but would not make 15 clusters, i.e. single categories. Also, the RMSE is smallest with only 5 clusters, which contradicts the assumption above. 

On the other hand, the predicted and observed values are less different than the statistics would suggest. For example, the predicted values are generally much smaller and the outliers are therefore less significant than with the observed data, which would allow the assumption that the high speeds are outliers and not actual changes in the speed of the animals but errors in the measurement, for example.

```{r}
plot(model)
print(model)

ggplot()+
  geom_line(data = predict_model_speed, aes(x = row_num, y = .), col = "red", size = 1.5)+
  geom_line(data = deer_cleaned, aes(x = row_num, y = speed), col = "blue", size = .3)+
  xlab("Data point")+
  ylab("Speed [m/s]")+
  ggtitle("Predicted speed [red] using k-nearest neighboors algorithm plotted \nagainst observed speed [blue] in roe deer")

```

# Discussion





<div>

# Bibliography
