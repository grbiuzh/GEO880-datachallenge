---
title: "Prediction of future movement in Roe Deer"
subtitle: "Data challenge :GEO880, Patterns and Trends in Environmental Data - Computational Movement Analysis"
author: "Tim Fässler and Gregory Biland"
date: "30/05/2022"
output:
  html_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r message=FALSE, warning=FALSE, =FALSE, include=FALSE}
Sys.setenv(LANG = "en")
library(readr)  # to import tabular data (e.g. csv)
library(tidyr)
library(tibble)
library(dplyr)        # to manipulate (tabular) data
library(sf)           # to handle spatial vector data
library(lubridate)    # To handle dates and times
library(ggplot2)
library(randomNames)
library(caTools)
library(caret)
library(neuralnet)
library(trajr)

knitr::opts_chunk$set(
  message = F,
  fig.width = 7,
  fig.height = 6,
  pandoc.stack.size = "4g",
  fig.align = 'center',
  opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
)

dataFolder   <- here::here()   
RFolder      <- here::here()         
figureFolder <- here::here("figs") 
```

```{r include=FALSE}
deer <- read_delim(file.path(dataFolder, "all_deer_complete.csv")) %>% data.frame()
canton_zh <- st_read(file.path(dataFolder,"Gemeindegrenzen_-OGD/UP_KANTON_F.shp"))
# ASTK <- read_delim(file.path(dataFolder, "Arealstatistik.csv"))
ASTK_ZH <- read_delim(file.path(dataFolder, "ASTK_ZH.csv"))
```

## Abstract
Animal movement has always been a complex field of study as it consists of and compiles the difficulties of ecology, geography and data science. This project seeks to merge these three disciplines as it tries to predict the future movement of Roe Deer through space with the usage of an aritificical neural network with constraints set up by typical biological behaviours of the Roe Deer.

## Background and research goals
- What parameters are crucial for modeling and predicting deer movement patterns using an artificial neural network (ANN), and how much does the deers gender influence these models?

- Does the articifical neural network differentiate significantly between the deers movement in different kind of landscape spaces, for example forest vs on an open grass field.

## Methods and data

### Data
```{r}
#To test make subset of df

deer <- subset(deer[1:100,])

head(deer)
```

### Preprocessing

```{r}
#deer <- deer %>% group_by(reh) %>% mutate(Name = randomNames(reh, ethnicity = 4)) #Give deer names
canton_zh <- canton_zh %>% subset(KANTON == "Zürich")
canton_zh <- canton_zh %>% st_transform(2056)

# ASTK <- ASTK %>% st_as_sf(coords = c("E", "N"), crs = 2056, remove = FALSE)
# ASTK_ZH <- st_join(canton_zh, ASTK, join = st_contains_properly, left=TRUE)
# ASTK_ZH <- ASTK_ZH %>% st_drop_geometry()
# write.csv(ASTK_ZH, file = "ASTK_ZH.csv", row.names=FALSE)

# Sex to binary: male = 0, female = 1, rename "reh" to "TierID"
deer$sex[deer$sex == "m"] <- as.numeric(0)
deer$sex[deer$sex == "f"] <- as.numeric(1)

deer <- deer %>% rename(TierID = reh, DatetimeUTC = datetime_utc,)

deer <- deer %>% mutate(
  y = y + 2000000,
  x = x + 1000000
)

```

### Geometry calculations

```{r}
deer <- deer %>% group_by(TierID) %>% mutate(
  timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC)), #timelag is in minutes
  steplength = sqrt((y - lead(y,1))^2+ (x - lead(x,1))^2))

deer <- deer %>% mutate(speed = (steplength / timelag)*3.6) #km/h -> Aber fallsch da steplength nicht immer gleich lang ist
deer <- deer %>% drop_na() %>% data.frame() %>% subset(select= -c(longitude, latitude) )
deer$sex <- as.numeric(as.character(deer$sex))

deer <- TrajFromCoords(deer)

# Measures of speed
derivs <- TrajDerivatives(deer)

deer <- deer %>% 
  mutate(
  mean_speed = mean(derivs$speed),
  sd_speed = sd(derivs$speed),
  sinuosity = TrajSinuosity(deer),
  Emax = TrajEmax(TrajRediscretize(deer, .001)),
  min_deltaS = TrajDAFindFirstMinimum(TrajDirectionAutocorrelations(TrajRediscretize(deer, .001), 1))[1],
  min_C = TrajDAFindFirstMinimum(TrajDirectionAutocorrelations(TrajRediscretize(deer, .001), 1))[2]
)

#assign new columns for predicted values

# Next x (nx): x coordinate at next moment
# Next y (ny): y coordinate at next moment
# dx: delta X = nx — x
# dy: delta Y = ny — y

deer <- deer %>%
  add_column(FutLat="",
             FutLon="")

```
### Arealstatistik

```{r}
ASTK_ZH
```

```{r}
deer <- deer %>% st_as_sf(coords = c("E", "N"), crs = 2056, remove = FALSE)

ggplot()+
  geom_line(data = deer, aes(x=DatetimeUTC, y = speed, col= TierID))+
  ggtitle("Monitoring timespan for 15 different roe deer")+
  ylab("Deer")+
  xlab("Date")

ggplot()+
  geom_sf(data = canton_zh, fill = alpha("white", .1))+
  geom_path(data = deer, aes(x = E, y = N, col = TierID), alpha = 0.3)+
  geom_point(data = deer, aes(x = E, y = N, col = TierID), size = .1)+
  coord_sf(datum = 2056)+
  theme_minimal()+
  ggtitle("Tracking points for 15 different roe deer")

deer <- deer %>% st_drop_geometry()

```

```{r}
# Resample to 30 seconds steps
deer_resampled <- TrajResampleTime(deer, 0.01)
deer_resampled <- TrajFromCoords(deer_resampled)
```

### Methods

```{r Test and Trainigdata}

#Create training and test data with 80/20% ratio
set.seed(54)
sample <- sample.int(n = nrow(deer), size = floor(0.8*nrow(deer)), replace = F)
trainingset <- deer[sample, ]
testset  <- deer[-sample, ]

trainingset_clean <- select(trainingset, -c(DatetimeUTC, y, x)) %>% na.omit()
testset_clean <- select(testset, -c(DatetimeUTC, y, x)) %>% na.omit()
```

### Artificial neural network 
```{r ANN}
set.seed(54)

ann_model <- train(E + N ~ ., data= trainingset_clean, method="nnet", maxit = 1, trace=FALSE, MaxNWts=2600)
ann_model
plot(ann_model)

# Second ANN method

nn=neuralnet(E + N ~ .,data=trainingset_clean, hidden=3,act.fct = "logistic", 
                linear.output = FALSE)
plot(nn)

## Prediction using neural network
Predict=compute(nn,test)
Predict$net.result

# Converting probabilities into binary classes setting threshold level 0.5
prob <- Predict$net.result
pred <- ifelse(prob>0.5, 1, 0)
pred

```
```{r}

```


## Results


## Discussion


## Bibliography
