---
title: "Prediction of future movement in Roe Deer"
subtitle: "Data challenge :GEO880, Patterns and Trends in Environmental Data - Computational Movement Analysis"
author: "Tim Fässler and Gregory Biland"
date: "30/05/2022"
output:
  html_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r message=FALSE, warning=FALSE, =FALSE, include=FALSE}
Sys.setenv(LANG = "en")
library(readr)  # to import tabular data (e.g. csv)
library(tidyr)
library(tibble)
library(dplyr)        # to manipulate (tabular) data
library(sf)           # to handle spatial vector data
library(lubridate)    # To handle dates and times
library(ggplot2)
library(randomNames)
library(caTools)
library(caret)
library(neuralnet)
library(trajr)
library(raster)

knitr::opts_chunk$set(
  message = F,
  fig.width = 7,
  fig.height = 6,
  pandoc.stack.size = "4g",
  fig.align = 'center',
  opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
)

dataFolder   <- here::here()   
RFolder      <- here::here()         
figureFolder <- here::here("figs") 
```

```{r include=FALSE}
deer <- read_delim(file.path(dataFolder, "all_deer_complete.csv")) %>% data.frame()
canton_zh <- st_read(file.path(dataFolder,"Gemeindegrenzen_-OGD/UP_KANTON_F.shp"))
# ASTK <- read_delim(file.path(dataFolder, "Arealstatistik.csv"))
ASTK_ZH <- read_delim(file.path(dataFolder, "ASTK_ZH.csv"))
```

## Abstract
Animal movement has always been a complex field of study as it consists of and compiles the difficulties of ecology, geography and data science. This project seeks to merge these three disciplines as it tries to predict the future movement of Roe Deer through space with the usage of an aritificical neural network with constraints set up by typical biological behaviours of the Roe Deer.

## Background and research goals
- What parameters are crucial for modeling and predicting deer movement patterns using an artificial neural network (ANN), and how much does the deers gender influence these models?

- Does the articifical neural network differentiate significantly between the deers movement in different kind of landscape spaces, for example forest vs on an open grass field.

## Methods and data

### Data
```{r}
#To test make subset of df

deer <- subset(deer[1:100,])

head(deer)
```

### Preprocessing

```{r}
#deer <- deer %>% group_by(reh) %>% mutate(Name = randomNames(reh, ethnicity = 4)) #Give deer names
canton_zh <- canton_zh %>% subset(KANTON == "Zürich")
canton_zh <- canton_zh %>% st_transform(2056)

# ASTK <- ASTK %>% st_as_sf(coords = c("E", "N"), crs = 2056, remove = FALSE)
# ASTK_ZH <- st_join(canton_zh, ASTK, join = st_contains_properly, left=TRUE)
# ASTK_ZH <- ASTK_ZH %>% st_drop_geometry()
# write.csv(ASTK_ZH, file = "ASTK_ZH.csv", row.names=FALSE)

# Sex to binary: male = 0, female = 1, rename "reh" to "TierID"
deer$sex[deer$sex == "m"] <- as.numeric(0)
deer$sex[deer$sex == "f"] <- as.numeric(1)

deer <- deer %>% rename(TierID = reh, DatetimeUTC = datetime_utc)

deer <- deer %>% mutate(
  y = y + 2000000,
  x = x + 1000000
)

# Making a bounding box of the relevant study area
deer <- deer %>% st_as_sf(coords = c("y", "x"), crs = 2056, remove = FALSE) 
bbox <- st_make_grid(st_bbox(deer), n = 1)
bbox_df <- bbox[[1]][[1]] %>% data.frame()
deer <- deer %>% st_drop_geometry()

# Making the bounding box a bit bigger, so that our predictions can go further outside, 1km on every side
bbox_df$X1[1] = bbox_df$X1[1] - 1000
bbox_df$X1[2] = bbox_df$X1[2] + 1000
bbox_df$X1[3] = bbox_df$X1[3] + 1000
bbox_df$X1[4] = bbox_df$X1[4] - 1000
bbox_df$X1[5] = bbox_df$X1[5] - 1000

bbox_df$X2[1] = bbox_df$X2[1] - 1000
bbox_df$X2[2] = bbox_df$X2[2] - 1000
bbox_df$X2[3] = bbox_df$X2[3] + 1000
bbox_df$X2[4] = bbox_df$X2[4] + 1000
bbox_df$X2[5] = bbox_df$X2[5] - 1000
bbox_sf <- bbox_df %>% st_as_sf(coords = c('X1', 'X2'), crs = 2056) %>% 
  summarise(geometry = st_combine(geometry)) %>%
  st_cast("POLYGON")

```

### Geometry calculations

```{r}
deer <- deer %>% group_by(TierID) %>% mutate(
  timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC, units = 'secs')), #timelag is in minutes
  steplength = sqrt((y - lead(y,1))^2+ (x - lead(x,1))^2))

deer <- deer %>% mutate(speed = (steplength / timelag)) #km/h -> Aber falsch da steplength nicht immer gleich lang ist --> sött doch eigentlich scho stimme wil ja steplength und timelag beidi grösser werded, glicht sich us, m/s macht glaub au meh sinn solang mer mit koordinate schaffed wo in meter sind und das trajr package au immer mit m/s schaffed 
deer <- deer %>% drop_na() %>% data.frame() %>% subset(select= -c(longitude, latitude) )
deer$sex <- as.numeric(as.character(deer$sex))

deer <- TrajFromCoords(deer, timeCol = 'DatetimeUTC') 
deer <- deer %>% mutate(displacementTime = as.integer(displacementTime))

# Measures of speed
derivs <- TrajDerivatives(deer)

deer <- deer %>% 
  mutate(
  mean_speed = mean(derivs$speed),
  sd_speed = sd(derivs$speed),
  sinuosity = TrajSinuosity(deer), 
  Emax = TrajEmax(TrajRediscretize(deer, .001)), # funktioniert das überhaupt mit dem rediscretize ide funktion? müsstmer denn nöd grad sganze trajectory file, dasmer überall de gliche resamplete steptime hend?
  min_deltaS = TrajDAFindFirstMinimum(TrajDirectionAutocorrelations(TrajRediscretize(deer, .001), 1))[1],
  min_C = TrajDAFindFirstMinimum(TrajDirectionAutocorrelations(TrajRediscretize(deer, .001), 1))[2]
)

#assign new columns for predicted values

# Next x (nx): x coordinate at next moment
# Next y (ny): y coordinate at next moment
# dx: delta X = nx — x
# dy: delta Y = ny — y

deer <- deer %>%
  add_column(FutLat= "",
             FutLon= "") 

deer$FutLon <- NA
deer$FutLat <- NA

```
### Arealstatistik

```{r}

# Extracting the relevant cells of the Arealstatistik
ASTK_ZH <- ASTK_ZH %>% st_as_sf(coords = c("E", "N"), crs = 2056, remove = FALSE)
ASTK_bbox <- st_join(bbox_sf, ASTK_ZH, join = st_contains_properly, left=TRUE)
ASTK_bbox <- ASTK_bbox %>% st_drop_geometry(ASTK_bbox)

# Chosing which classification of the Arealstatistik we want to use
ASTK_bbox <- ASTK_bbox %>% dplyr::select(RELI, E, N, AS18_72)

# Making an empty raster with the extent of the Arealstatistik
empty_raster <- raster(
  ncols = (range(ASTK_bbox$E)[2]-range(ASTK_bbox$E)[1])/100+1, 
  nrows =  (range(ASTK_bbox$N)[2]-range(ASTK_bbox$N)[1])/100+1, 
  xmn = min(ASTK_bbox$E)-50, 
  xmx = max(ASTK_bbox$E)+50, 
  ymn = min(ASTK_bbox$N)-50,
  ymx = max(ASTK_bbox$N)+50
  )

# Populating the raster
ASTK_raster <- rasterize(dplyr::select(ASTK_bbox, E, N), empty_raster, ASTK_bbox$AS18_72) 

# Adding arealstatistik values to deer data
deer <- data.frame(deer)
deer$astk <- as.vector(extract(ASTK_raster, st_as_sf(deer, coords = c("x", "y")) , 'simple'))


```

```{r}
deer <- deer %>% st_as_sf(coords = c("y", "x"), crs = 2056, remove = FALSE)
raster_vis <- as.data.frame(ASTK_raster, xy = TRUE)

ggplot()+
  geom_line(data = deer, aes(x=DatetimeUTC, y = speed, col= TierID))+
  ggtitle("Monitoring timespan for 15 different roe deer")+
  ylab("Deer")+
  xlab("speed")

ggplot()+
  # geom_sf(data = canton_zh, fill = alpha("white", .1))+
  geom_sf(data = bbox_sf)+
  geom_raster(data = raster_vis, aes(x = x, y = y, alpha = layer))+
  geom_path(data = deer, aes(x = x, y = y, col = TierID), alpha = 0.3)+
  geom_point(data = deer, aes(x = x, y = y, col = TierID), size = .1)+
  coord_sf(datum = 2056)+
  theme_minimal()+
  ggtitle("Tracking points for roe deer")
  

ggplot()+
  geom_raster(data = raster_vis, aes(x = x, y = y, alpha = layer))+
  coord_sf(datum =2056)+
  geom_point(data = deer, aes(x,y, color = as.factor(astk)))

deer <- deer %>% st_drop_geometry()

```

### Methods

```{r Test and Trainigdata}
#Create training and test data with 80/20% ratio
set.seed(54)

sample <- sample.int(n = nrow(deer), size = floor(0.8*nrow(deer)), replace = F)
trainingset <- deer[sample, ]
testset  <- deer[-sample, ]

trainingset <- select(trainingset, -c(DatetimeUTC, polar, displacement))
testset <- select(testset, -c(DatetimeUTC, polar, displacement))
```

### Artificial neural network 
```{r ANN}
set.seed(54)

# Second ANN method

model1 = neuralnet(FutLat ~ .,data=trainingset, hidden=3,act.fct = "logistic", 
                linear.output = FALSE)

model1 = neuralnet(FutLon ~ .,data=trainingset_clean, hidden=3,act.fct = "logistic", 
                linear.output = FALSE)

## Prediction using neural network
Predict_x=compute(nn,model1)
Predict_y=compute(nn,model1)

Predict_x$net.result
Predict_y$net.result

```
```{r}

```


## Results
```{r}

```


## Discussion


## Bibliography
